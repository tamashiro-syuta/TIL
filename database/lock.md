---
title: "データベースのロック"
tags: ["DB", "ロック"]
---

# データベースのロック

## ロックの種類

### 排他ロック(Exclusive Lock)
- 排他ロックは、あるトランザクションが特定のデータに対して「独占的に」アクセスするためのロック
- このロックがかかっている間は、他のトランザクションがそのデータを読み書きすることができない
- 排他ロック中に他のトランザクションがデータにアクセスしようとすると、ロックを取得できないので、データの更新が完了するまで待つ
  - この待ち状態が互いに起きている状態を**デッドロック**という
- 排他ロックは、**排他ロック**とも呼ばれる

#### デッドロックが起きるケース
- トランザクションAがレコードXに専有ロックをかけ、トランザクションBがレコードYに専有ロックをかけたとする
- その後、トランザクションAがレコードYに対して専有ロックを取得しようとし、トランザクションBがレコードXに対して専有ロックを取得しようとする
- この時、トランザクションAはトランザクションBのロックを待っていて、トランザクションBはトランザクションAのロックを待っているので、互いに相手のロックを待つ状態になり、デッドロックが発生する


### 共有ロック(Shared Lock)
- 共有ロックは、特定のデータに対して複数のトランザクションが同時に読み取りを行うことを許可
  - つまり、他のトランザクションもそのデータを読み取ることができますが、書き込みはできまない

#### デッドロックが起きるケース
- トランザクションAがレコードXに共有ロックをかける
  - トランザクションAは、レコードXを読み取るために共有ロックを取得
  - この時点で、他のトランザクションもレコードXを読み取ることができるが、書き込みはできない
- トランザクションBがレコードYに共有ロックをかける
  - トランザクションBは、レコードYを読み取るために共有ロックを取得
  - この時点で、他のトランザクションもレコードYを読み取ることができるが、書き込みはできない
- トランザクションAがレコードYに対して専有ロックを取得しようとする
  - トランザクションAは、レコードYに対して専有ロックを取得しようとする
  - トランザクションAは、レコードYを独占的に変更したいと考えている
  - しかし、トランザクションBがすでにレコードYに共有ロックをかけているため、トランザクションAはロックを取得できず、待機状態になる
- トランザクションBがレコードXに対して専有ロックを取得しようとする
  - トランザクションBは、レコードXを独占的に変更したいと考えている
  - しかし、トランザクションAがすでにレコードXに共有ロックをかけているため、トランザクションBもロックを取得できず、待機状態になる
- **共有ロックの状態から専有ロックをかけに行く時って書き込みをしようとしているって判断されているから、専有ロックが待ちの状態(共有ロックの解除待ち)になる**

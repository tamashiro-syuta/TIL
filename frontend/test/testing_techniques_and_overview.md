# テストの手法一覧
- **関数単体テスト**
    - 通常の単体テストと同じ
- **UIコンポーネントテスト**
    - 多分、storybookがここに当たる？
    - 最近のフロントエンドはコンポーネントごとに分割されているからテストしやすい
- **UIコンポーネント結合テスト**
    - “操作に応じた非同期通信の実行” や “レスポンスに応じた表示の切り替え” など、外部要因も含めてテストを行う
- **UIコンポーネントビジュアルリグレッションテスト**
    - スタイルシートの指定に基づく出力結果を検証するテスト
    - コンポーネント単位で行うので、精度が高い
    - ※ リグレッションテスト = ある特定の時点から、前後の差分を検出して想定外の不具合が発生していないかを検証するテスト
- **E2Eテスト**
    - ヘッドレスブラウザなどを用いて行うより本番のアプリケーションに近いテスト
    - ブラウザ固有のAPIや画面を跨ぐ操作のテストに向いている

# テストを書く障壁
- **テストを書く工数を予め、入れておけ**
- **テストを書くと長期的には開発効率が上がる**

# テスト手法とテスト戦略
テストを追加する前に、**テストの「範囲」と「目的」の組み合わせを理解することが大切**

## テストの範囲と、それに応じたテスト手法

### 【 テストの範囲 】

1. ライブラリが提供する関数
2. ロジックを担う関数
3. UIを表現する関数
4. Web APIクライアント
5. APIサーバー
6. DBサーバー

### 「どこ」をテストするかに応じたテスト手法の分類

- **静的解析 (ESLintなど)**
    - 1つ1つのモジュール +  (①と②の間などの) 隣接するモジュール間連携の不整合 を検証
- **単体テスト**
    - **「モジュール単体が提供する機能」に着目**したテスト
    - アプリケーション稼働時には滅多に発生しないケースの検証に向いている
        - 実際に操作せずに挙動がわかるため
    - **入力値(Props)と出力値(UIコンポーネント)をテストできるので、実装漏れや考慮漏れを防ぎやすい！**
        - 例外としてキャッチするパターンをテストするので、その時に実装漏れなどに気づきやすい
- **結合テスト**
    - (①と②の間など)「モジュールをつなげることで提供できる機能」に着目したテスト
        - 「ここが変更されたら、ここも変更されるよね〜」をテストできる
        - ex) テストケース例
            - **結合テストにすることで、ユースケースがわかりやすくなる**
                - 小さなそれぞれのケースの積み重ねをそれぞれテストした場合、どのユースケースでのテストかがわかりずらい
            1. セレクトボックスを操作
            2. URLの検索クエリーが変化
            3. 検索クエリーの変化により、データ取得APIが呼ばれる
            4. 一覧表示内容が変更される
    - 広範囲をテストできるが、逆にざっくりとした検証になる傾向がある
- **E2Eテスト**
    - ① ~ ⑥を通し、ヘッドレスブラウザ + UIオートメーション で実施するテスト
    - **E2Eテストでは、UIテストに加えて外部サービスとの連携や、画面を跨いだテストが可能**
    - 最も広範囲な結合テストともいえるので、実際に稼働するアプリケーションとして忠実なテスト

### 「なに」をテストするかに応じたテスト手法の分類

- **機能テスト(インタラクションテスト)**
    - (フロントエンドの文脈でいうと) UIコンポーネントの操作をテストする箇所
    - 通常のインタラクティブテストと、Reactなどのインタラクティブテストの違い
        - 通常 ⇒ ヘッドレスブラウザで実施
        - React ⇒ 仮想ブラウザ環境で実施
        - **※ 画面スクロールなど、実際のブラウザ環境が必要な場合は、ヘッドレスブラウザでテストする**
- **非機能テスト(アクセシビリティテスト)**
    - (フロントエンドの文脈でいうと) 心身特性のある方にも機能提供できているか(アクセシビリティに配慮しているか)を検証
        - ex)
            - チェックボックスとしてチェックできる
            - エラー時のテキストは読み上げ対象としてレンダリングされる
- **リグレッションテスト**
    - (フロントエンドの文脈でいうと) UIコンポーネントが特定時点から想定外の不具合が発生していないかをテスト
        - ヘッドレスブラウザに描画された内容をキャプチャし、キャプチャされた画像を比較することで、見た目のリグレッションがないかを検証するテスト
        - ex)
            - ボタンの見た目にリグレッションがない
            - メニューバーを開いた際の状態にリグレッションがない
    - リグレッションテストはブラウザに読み込まれたCSS全ての影響を受ける
        - CSS Base Line などによる影響なども全て含めてテストできる = 実際の環境に**忠実なテスト**ができる

# 【テスト戦略モデル】

- 実際のテスト環境に近づけるほど、コストや工数がかかる(運用コストも)
    - ex) E2Eテストをするには、実行環境、ダミーデータが保存してあるDBを用意など、、、

    ![IMG_1982.heic](https://gihyo.jp/assets/images/dev/serial/01/savanna-letter/0005/02.jpg)

- **このようなテストとコストの最適化をどのように設計するかがテスト戦略モデル**

## アイスクリームコーン型

- **❌ アンチパターン!!!**
- E2Eなどの上層のテストが多いケース
- コストが高い
- 実行に時間がかかる
- 開発体験も良くない
    - 開発体験をよくするのもテストの役割

![アイスクリームコーン型](https://gihyo.jp/assets/images/dev/serial/01/savanna-letter/0005/02.jpg)

## テストピラミッド型

- ⭕️ **ベストプラクティス!!!**
- **コストも低く、安定した高速なテストになる！**
    - chapiなどはこっちよりのテスト戦略を取っている
- 実行時間も短いため、開発体験も良い
- **※ ただし、忠実性は低い**

![テストピラミッド型](https://gihyo.jp/assets/images/dev/serial/01/savanna-letter/0005/01.jpg)

## テスティングトロフィー型

- ⭕️ **ベストプラクティス!!!**
- **「結合テスト」に最も比重を置いている**
    - Webフロントエンドは複数コンポーネントを組み合わせて機能するケースがほとんどのため
- ヘッドレスブラウザの用意が不要なため、**実行速度の速く、忠実性が高い**
- フロントエンドに寄せたテスト戦略
- Testing Libraryの開発者が提唱

![テスティングトロフィー](https://miro.medium.com/v2/resize:fit:1248/format:webp/0*4Ug2VfpQAwyUCyLz.png)

### 【テスト戦略モデル】

- プロダクトにおける **「テスト対象は何か？」「目的は何か？」の判断基準を持つことが大切**
    - イタズラにテストをするだけでは勿体無い。
    - **限られたリソースの中でテスト対象や優先度を把握し、共有することが大切**
- **テストがなく、リファクタに不安が生じる場合**
    - リリース済みの機能の洗い出し
        - 変更前後で欠陥が混ざってないかをテストしたい ⇒ リグレッションテストが良い
        - リグレッションテストを書く ⇒ ソースの積極的なリファクタに取り組める
    - APIへの依存が強い場合
        - **APIサーバーをモックサーバーに切り替えて、段階的に結合テストを増やしていく**とやりやすい
        - 「モックサーバーなので好きにデータをいじっても大丈夫だからテストも書きやすくなるよね」的な発想？？
- **レスポンシブデザインが重要なPJの場合**
    - よくあるケース
        - PC版のスタイルを変更したら、SP版のスタイルも変更されてしまった….. ><
    - **ブラウザを用いたビジュアルリグレッションテストが大切**
        - StorybookだとUIコンポーネントをPC版、SP版の両方でリグレッションテストできる
- **データ永続化を含めたE2Eテストを行いたい場合**
    - データ永続化を含めたE2Eテストを行いたい場合 ⇒ **実際のAPIサーバーを含めたE2EテストをSTGで行うことで対応**
        - ⚠️ **STGでのE2Eテストはアイスクリーム型のテスト戦略になりがちなので注意 (テストの目的を決めた上での選定なら🙆)**
    - E2Eは以下の方法がある
        - STGでE2Eの自動テストを行う
        - テストコンテナを用意して、CIでコンテナを起動、テスト実行まで行う
            - この場合は開発エンジニアだけでもカバーできる👍
